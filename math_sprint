"""
Math Sprint - aplikacja webowa (Python + Streamlit)

Instrukcja lokalna:
1. Zainstaluj Python 3.9+.
2. Zainstaluj Streamlit i Pandas:
   pip install -r requirements.txt
3. Uruchom lokalnie:
   streamlit run math_sprint.py

Instrukcja wdroÅ¼enia online (Streamlit Cloud):
1. WejdÅº na https://share.streamlit.io
2. Zaloguj siÄ™ kontem GitHub.
3. UtwÃ³rz nowe repozytorium na GitHub i dodaj do niego dwa pliki:
   - math_sprint.py (ten plik)
   - requirements.txt (zawartoÅ›Ä‡ poniÅ¼ej)
4. Wybierz "New app" â†’ wskaÅ¼ repozytorium i plik `math_sprint.py`.
5. Kliknij "Deploy" â€” aplikacja bÄ™dzie dostÄ™pna publicznie pod wÅ‚asnym linkiem.

Plik requirements.txt:
----------------------
streamlit
pandas
----------------------

Opis dziaÅ‚ania:
- UczeÅ„ wpisuje imiÄ™ i zaczyna grÄ™.
- PojawiajÄ… siÄ™ dziaÅ‚ania: dodawanie, odejmowanie, mnoÅ¼enie, dzielenie.
- Ma 5 sekund na kaÅ¼dÄ… odpowiedÅº.
- JeÅ›li poda dobrÄ… odpowiedÅº w czasie, dostaje punkty i pojawia siÄ™ trudniejsze zadanie.
- Gra trwa, dopÃ³ki odpowiada poprawnie.
- Wyniki zapisywane sÄ… do pliku CSV (ranking publiczny).
- Ranking pokazuje sumÄ™ punktÃ³w i najlepszy wynik ucznia.
"""

import streamlit as st
import pandas as pd
import random
import time
import os

# --- Ustawienia ---
DATA_FILE = "ranking.csv"
TIME_LIMIT = 5  # sekundy

# --- Funkcje pomocnicze ---
def generate_problem(level: int):
    max_base = min(10 + int(level * 1.5), 200)
    op = random.choice(["+", "-", "*", "/"])
    a = random.randint(1, max_base)
    b = random.randint(1, max(1, max_base // (4 if op == '*' else 2)))

    if op == "/":
        result = random.randint(1, min(12, int(level / 2 + 3)))
        divisor = b
        dividend = result * divisor
        text = f"{dividend} / {divisor}"
        return text, result
    elif op == "+":
        return f"{a} + {b}", a + b
    elif op == "-":
        return f"{a} - {b}", a - b
    else:
        return f"{a} * {b}", a * b


def load_ranking():
    if not os.path.exists(DATA_FILE):
        return pd.DataFrame(columns=["name", "score"])
    return pd.read_csv(DATA_FILE)


def save_score(name: str, score: int):
    df = load_ranking()
    new_row = pd.DataFrame([[name, score]], columns=["name", "score"])
    df = pd.concat([df, new_row], ignore_index=True)
    df.to_csv(DATA_FILE, index=False)


def build_leaderboard(df: pd.DataFrame):
    if df.empty:
        return pd.DataFrame(columns=["UczeÅ„", "Suma punktÃ³w", "Najlepsza sesja", "Sesje"])
    grouped = df.groupby("name").agg(
        Suma_punktÃ³w=("score", "sum"),
        Najlepsza_sesja=("score", "max"),
        Sesje=("score", "count"),
    ).reset_index().rename(columns={"name": "UczeÅ„"})
    grouped = grouped.sort_values(by=["Suma_punktÃ³w", "Najlepsza_sesja"], ascending=False)
    return grouped

# --- UI ---
st.set_page_config(page_title="Math Sprint", layout="wide")
st.title("ğŸ§® Math Sprint â€” gra matematyczna")
st.write("Odpowiadaj poprawnie w 5 sekund â€” gra trwa, dopÃ³ki nie popeÅ‚nisz bÅ‚Ä™du.")

col1, col2 = st.columns([2, 1])

with col1:
    name = st.text_input("Twoje imiÄ™ (widoczne w rankingu)", key="name")
    if "game_state" not in st.session_state:
        st.session_state.game_state = "ready"  # ready, playing, ended
        st.session_state.level = 1
        st.session_state.score = 0
        st.session_state.problem = None
        st.session_state.answer = None
        st.session_state.start_time = None

    def start_game():
        if not name.strip():
            st.warning("Wpisz imiÄ™, aby rozpoczÄ…Ä‡ grÄ™!")
            return
        st.session_state.game_state = "playing"
        st.session_state.level = 1
        st.session_state.score = 0
        problem, ans = generate_problem(1)
        st.session_state.problem = problem
        st.session_state.answer = ans
        st.session_state.start_time = time.time()

    def end_game():
        st.session_state.game_state = "ended"
        save_score(name.strip(), st.session_state.score)

    if st.session_state.game_state == "ready":
        if st.button("â–¶ï¸ Start gry"):
            start_game()

    elif st.session_state.game_state == "playing":
        elapsed = time.time() - st.session_state.start_time
        remaining = TIME_LIMIT - elapsed

        if remaining <= 0:
            st.error(f"â° Czas minÄ…Å‚! TwÃ³j wynik: {st.session_state.score} pkt.")
            end_game()
        else:
            st.metric("PozostaÅ‚y czas", f"{remaining:.1f}s")
            st.subheader(f"Zadanie: {st.session_state.problem}")
            user_input = st.text_input("Wpisz odpowiedÅº i naciÅ›nij Enter:", key="answer_input")
            if user_input:
                try:
                    val = float(user_input)
                    if abs(val - st.session_state.answer) < 1e-6:
                        st.success("âœ… Poprawna odpowiedÅº!")
                        st.session_state.score += max(1, st.session_state.level // 2 + 1)
                        st.session_state.level += 1
                        problem, ans = generate_problem(st.session_state.level)
                        st.session_state.problem = problem
                        st.session_state.answer = ans
                        st.session_state.start_time = time.time()
                        st.experimental_rerun()
                    else:
                        st.error(f"âŒ BÅ‚Ä™dna odpowiedÅº! TwÃ³j wynik: {st.session_state.score} pkt.")
                        end_game()
                except ValueError:
                    st.warning("Podaj liczbÄ™.")

        st.write(f"**Poziom:** {st.session_state.level} | **Wynik:** {st.session_state.score}")
        if st.button("ğŸ³ï¸ Poddaj siÄ™"):
            st.warning(f"Koniec gry! TwÃ³j wynik: {st.session_state.score} pkt.")
            end_game()

    elif st.session_state.game_state == "ended":
        st.success(f"Koniec gry! TwÃ³j wynik: {st.session_state.score} pkt.")
        if st.button("ğŸ” Zagraj ponownie"):
            st.session_state.game_state = "ready"
            st.experimental_rerun()

with col2:
    st.subheader("ğŸ† Ranking publiczny")
    df = load_ranking()
    leaderboard = build_leaderboard(df)
    st.dataframe(leaderboard, use_container_width=True)
    st.caption("Ranking pokazuje sumÄ™ punktÃ³w oraz najlepszy wynik kaÅ¼dej osoby.")
